<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Museum Wayfinding</title>
  <style>
    /* Simple CSS to make it look like a mobile app */
    body { font-family: sans-serif; text-align: center; padding: 20px; }
    button { padding: 15px 30px; font-size: 18px; background-color: #007BFF; color: white; border: none; border-radius: 8px; cursor: pointer; }
    .data-box { margin-top: 30px; padding: 20px; background-color: #f4f4f4; border-radius: 8px; }
    h1 { font-size: 24px; }
  </style>
</head>
<body>

  <h1>Dinosaur Exhibit Navigator</h1>
  <p>Click the button below to find nearby exhibits.</p>
  
  <button id="scanButton">Scan for Exhibit</button>

  <div class="data-box">
    <h3 id="statusText">Status: Waiting...</h3>
    <h2 id="distanceText">Distance: -- meters</h2>
    <p id="rssiText">Signal Strength (RSSI): --</p>
  </div>

  <script>
    // 1. The Distance Math Formula
    function calculateDistance(rssi) {
      const txPower = -59; // Expected RSSI at 1 meter
      if (rssi === 0) return -1.0; 
      const ratio = rssi * 1.0 / txPower;
      if (ratio < 1.0) {
        return Math.pow(ratio, 10);
      } else {
        return (0.89976) * Math.pow(ratio, 7.7095) + 0.111;    
      }
    }

    // 2. The Bluetooth Scanning Logic
    document.getElementById('scanButton').addEventListener('click', async () => {
      try {
        document.getElementById('statusText').innerText = 'Status: Scanning...';

        // Request the specific ESP32 Bluetooth device
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ name: 'Dinosaur_Zone_Node' }] // Must match the ESP32 Arduino code!
        });

        document.getElementById('statusText').innerText = 'Status: Connected to ' + device.name;

        // 3. Listen for the Bluetooth signal strength (advertisements)
        device.addEventListener('advertisementreceived', (event) => {
          let currentRssi = event.rssi;
          let estimatedDistance = calculateDistance(currentRssi).toFixed(2); // Round to 2 decimal places

          // Update the HTML interface with the new numbers
          document.getElementById('rssiText').innerText = `Signal Strength (RSSI): ${currentRssi} dBm`;
          document.getElementById('distanceText').innerText = `Distance: ~${estimatedDistance} meters`;
          
          // Example of triggering an action based on distance!
          if(estimatedDistance < 2.0) {
            document.body.style.backgroundColor = "#d4edda"; // Turn background green if very close
          } else {
            document.body.style.backgroundColor = "white";
          }
        });

        // Start watching the signals
        await device.watchAdvertisements();

      } catch (error) {
        console.error(error);
        document.getElementById('statusText').innerText = 'Error: Could not connect.';
      }
    });
  </script>

</body>
</html>
