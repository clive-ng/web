<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Batch AI Uniform Cleaner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #cbd5e1; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef } = React;

        const App = () => {
            const [images, setImages] = useState([]);
            const [prompt, setPrompt] = useState(
                "Remove all the text, hand-drawn graphics, hand writing from the girl's dress and collar, making it a plain clean dress but leave the blue or red ribbon if it has. IMPORTANT: make sure all of the text are remove. Keep the original school logo on her dress. The new subject should look natural and photorealistic, with realistic skin texture, accurate facial proportions, and seamless blending into the scene. Match the original shadows, colour temperature, and perspective so the replacement is indistinguishable from the original photograph. High detail, sharp focus, professional photography quality."
            );
            
            const [namePrefix, setNamePrefix] = useState("unitf");
            const [downloadCount, setDownloadCount] = useState(1);
            const [zeroPadding, setZeroPadding] = useState(3);
            const [targetPath] = useState("/Volumes/ / /ai unifrom");
            const [isProcessing, setIsProcessing] = useState(false);
            const [globalError, setGlobalError] = useState(null);
            const fileInputRef = useRef(null);

            // API Key inserted below
            const apiKey = "AIzaSyAw_XAEgiSNPXfduMG12c6UiXnmHOfln3c"; 

            const fetchWithRetry = async (url, options, retries = 5) => {
                const delays = [1000, 2000, 4000, 8000, 16000];
                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch(url, options);
                        if (!response.ok) {
                            const data = await response.json().catch(() => ({}));
                            throw new Error(data.error?.message || `Status ${response.status}`);
                        }
                        return await response.json();
                    } catch (err) {
                        if (i === retries - 1) throw err;
                        await new Promise(res => setTimeout(res, delays[i]));
                    }
                }
            };

            const processFiles = (files) => {
                setGlobalError(null);
                const validFiles = Array.from(files).filter(f => f.type.startsWith('image/'));
                
                validFiles.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        setImages(prev => [...prev, {
                            id: crypto.randomUUID(),
                            dataUrl: e.target.result,
                            resultUrl: null,
                            status: 'idle',
                            fileName: null,
                            error: null
                        }]);
                    };
                    reader.readAsDataURL(file);
                });
            };

            const handleDrop = (e) => {
                e.preventDefault();
                processFiles(e.dataTransfer.files);
            };

            const handleGenerateBatch = async () => {
                const pending = images.filter(img => img.status === 'idle' || img.status === 'error');
                if (pending.length === 0 || isProcessing) return;

                setIsProcessing(true);
                setGlobalError(null);

                let currentCounter = downloadCount;

                for (const img of pending) {
                    setImages(prev => prev.map(i => i.id === img.id ? { ...i, status: 'processing', error: null } : i));

                    try {
                        const base64Data = img.dataUrl.split(',')[1];
                        const mimeType = img.dataUrl.match(/data:(.*?);base64/)[1];

                        const payload = {
                            contents: [{
                                parts: [
                                    { text: prompt },
                                    { inlineData: { mimeType, data: base64Data } }
                                ]
                            }],
                            generationConfig: { responseModalities: ["TEXT", "IMAGE"] }
                        };

                        // Using current stable Gemini 1.5 Flash endpoint for image processing
                        const result = await fetchWithRetry(
                            `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`,
                            {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            }
                        );

                        const outPart = result.candidates?.[0]?.content?.parts?.find(p => p.inlineData);
                        if (outPart?.inlineData?.data) {
                            const resultDataUrl = `data:image/png;base64,${outPart.inlineData.data}`;
                            const finalFileName = `${namePrefix}${String(currentCounter).padStart(zeroPadding, '0')}.png`;
                            
                            setImages(prev => prev.map(i => i.id === img.id ? { 
                                ...i, status: 'done', resultUrl: resultDataUrl, fileName: finalFileName 
                            } : i));

                            const link = document.createElement('a');
                            link.href = resultDataUrl;
                            link.download = finalFileName;
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);

                            currentCounter++;
                            setDownloadCount(currentCounter);
                        } else {
                            throw new Error("AI returned text but no image. Check if your prompt is too complex for the model.");
                        }
                    } catch (err) {
                        setImages(prev => prev.map(i => i.id === img.id ? { ...i, status: 'error', error: err.message } : i));
                    }
                }
                setIsProcessing(false);
            };

            const removeImage = (id) => {
                if (isProcessing) return;
                setImages(prev => prev.filter(img => img.id !== id));
            };

            const finishedCount = images.filter(img => img.status === 'done' || img.status === 'error').length;
            const progressPercent = images.length > 0 ? (finishedCount / images.length) * 100 : 0;

            return (
                <div className="min-h-screen text-slate-900 p-4 md:p-8">
                    <div className="max-w-6xl mx-auto space-y-8">
                        
                        <header className="text-center space-y-3">
                            <div className="flex items-center justify-center gap-4">
                                <div className="p-3 bg-indigo-600 rounded-2xl text-white shadow-xl">
                                    <i className="fa-solid fa-wand-magic-sparkles text-2xl"></i>
                                </div>
                                <h1 className="text-4xl font-extrabold tracking-tight">Batch Cleaner</h1>
                            </div>
                            <p className="text-slate-500 max-w-xl mx-auto text-lg font-medium">
                                AI Garment Refinement (Key Active)
                            </p>
                        </header>

                        {globalError && (
                            <div className="bg-red-50 border border-red-200 text-red-700 p-4 rounded-xl flex items-center gap-3">
                                <i className="fa-solid fa-circle-exclamation"></i>
                                <p className="text-sm font-medium">{globalError}</p>
                            </div>
                        )}

                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div className="space-y-6">
                                {/* Upload Section */}
                                <section className="bg-white rounded-3xl shadow-sm border border-slate-200 p-6 space-y-4">
                                    <div className="flex justify-between items-center">
                                        <h2 className="text-lg font-bold flex items-center gap-2">
                                            <i className="fa-solid fa-image text-indigo-600"></i> Queue ({images.length})
                                        </h2>
                                        {images.length > 0 && !isProcessing && (
                                            <button onClick={() => setImages([])} className="text-slate-400 hover:text-red-500 text-sm font-semibold">Clear</button>
                                        )}
                                    </div>
                                    <div onDragOver={(e) => e.preventDefault()} onDrop={handleDrop} onClick={() => !isProcessing && fileInputRef.current?.click()}
                                        className={`border-2 border-dashed rounded-2xl p-8 transition-all flex flex-col items-center justify-center gap-4 cursor-pointer
                                            ${images.length === 0 ? 'min-h-[160px]' : 'min-h-[100px]'}
                                            ${isProcessing ? 'opacity-50' : 'hover:border-indigo-400 hover:bg-indigo-50 border-slate-200 bg-slate-50/50'}`}>
                                        <input type="file" multiple accept="image/*" className="hidden" ref={fileInputRef} onChange={(e) => processFiles(e.target.files)} />
                                        <i className="fa-solid fa-cloud-arrow-up text-slate-300 text-2xl"></i>
                                        <p className="font-bold text-slate-700 text-sm">Upload Images</p>
                                    </div>
                                    {images.length > 0 && (
                                        <div className="grid grid-cols-5 gap-2 max-h-[150px] overflow-y-auto custom-scrollbar">
                                            {images.map(img => (
                                                <div key={img.id} className="relative aspect-square rounded-lg overflow-hidden border bg-slate-100 group">
                                                    <img src={img.dataUrl} className="w-full h-full object-cover" />
                                                    <div className="absolute inset-0 flex items-center justify-center bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity">
                                                        <button onClick={(e) => { e.stopPropagation(); removeImage(img.id); }} className="text-white text-xs"><i className="fa-solid fa-trash"></i></button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </section>

                                {/* Settings */}
                                <section className="bg-white rounded-3xl shadow-sm border border-slate-200 p-6 space-y-4">
                                    <div className="grid grid-cols-3 gap-4">
                                        <div>
                                            <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-1">Prefix</label>
                                            <input type="text" value={namePrefix} onChange={(e) => setNamePrefix(e.target.value)} className="w-full p-2 bg-slate-50 border rounded-lg text-sm" />
                                        </div>
                                        <div>
                                            <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-1">Start #</label>
                                            <input type="number" value={downloadCount} onChange={(e) => setDownloadCount(parseInt(e.target.value))} className="w-full p-2 bg-slate-50 border rounded-lg text-sm" />
                                        </div>
                                        <div>
                                            <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-1">Padding</label>
                                            <select value={zeroPadding} onChange={(e) => setZeroPadding(parseInt(e.target.value))} className="w-full p-2 bg-slate-50 border rounded-lg text-sm">
                                                <option value="1">1</option><option value="2">01</option><option value="3">001</option>
                                            </select>
                                        </div>
                                    </div>
                                </section>

                                {/* Prompt & Run */}
                                <section className="bg-white rounded-3xl shadow-sm border border-slate-200 p-6 space-y-4">
                                    <textarea value={prompt} onChange={(e) => setPrompt(e.target.value)} className="w-full min-h-[100px] p-3 text-xs bg-slate-50 border rounded-xl" />
                                    <button onClick={handleGenerateBatch} disabled={isProcessing || images.length === 0}
                                        className="w-full py-4 bg-indigo-600 hover:bg-indigo-700 disabled:bg-slate-200 text-white font-bold rounded-2xl shadow-lg transition-all flex items-center justify-center gap-3">
                                        {isProcessing ? <i className="fa-solid fa-sync fa-spin"></i> : <i className="fa-solid fa-bolt"></i>}
                                        {isProcessing ? 'Processing Batch...' : `Start Cleaning Batch`}
                                    </button>
                                </section>
                            </div>

                            {/* Gallery Section */}
                            <section className="bg-white rounded-3xl shadow-sm border border-slate-200 p-6 flex flex-col min-h-[500px]">
                                <h2 className="text-lg font-bold flex items-center gap-2 text-emerald-600 mb-6">
                                    <i className="fa-solid fa-circle-check"></i> Results Gallery
                                </h2>
                                <div className="flex-grow space-y-4 overflow-y-auto custom-scrollbar">
                                    {images.length === 0 ? (
                                        <div className="h-full flex flex-col items-center justify-center text-slate-300 opacity-40">
                                            <i className="fa-solid fa-images text-5xl mb-4"></i>
                                            <p className="font-bold text-sm">Ready for input</p>
                                        </div>
                                    ) : (
                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                            {images.map(img => (
                                                <div key={`res-${img.id}`} className="bg-slate-50 border border-slate-200 rounded-2xl p-3 space-y-3">
                                                    <div className="aspect-square rounded-xl overflow-hidden bg-slate-200 flex items-center justify-center border">
                                                        {img.status === 'done' ? <img src={img.resultUrl} className="w-full h-full object-contain" /> :
                                                         img.status === 'processing' ? <i className="fa-solid fa-sync fa-spin text-indigo-500"></i> :
                                                         img.status === 'error' ? <div className="p-2 text-[10px] text-red-500 text-center">{img.error}</div> :
                                                         <i className="fa-solid fa-hourglass-start text-slate-300"></i>}
                                                    </div>
                                                    <div className="flex items-center justify-between px-1">
                                                        <p className="text-[11px] font-bold text-slate-700 truncate max-w-[120px]">{img.fileName || 'Pending'}</p>
                                                        {img.status === 'done' && (
                                                            <a href={img.resultUrl} download={img.fileName} className="text-emerald-600 hover:text-emerald-800">
                                                                <i className="fa-solid fa-download"></i>
                                                            </a>
                                                        )}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </section>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
