<script>
    const ESP32_SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";

    // --- NEW: The Smoothing Filter Array ---
    let rssiHistory = [];
    const MAX_HISTORY = 5; // Average the last 5 pings. Increase this number for more stability (but slower reaction time).

    function calculateDistance(rssi) {
      const txPower = -59; 
      if (rssi === 0) return -1.0; 
      const ratio = rssi * 1.0 / txPower;
      if (ratio < 1.0) {
        return Math.pow(ratio, 10);
      } else {
        return (0.89976) * Math.pow(ratio, 7.7095) + 0.111;    
      }
    }

    function hideAllZones() {
      document.getElementById('zoneFar').classList.remove('active-zone');
      document.getElementById('zoneNear').classList.remove('active-zone');
      document.getElementById('zoneImmediate').classList.remove('active-zone');
    }

    document.getElementById('scanButton').addEventListener('click', async () => {
      const statusText = document.getElementById('statusText');
      const distanceText = document.getElementById('distanceText');
      rssiHistory = []; // Clear history on new connection

      try {
        statusText.innerText = 'Scanning...';

        const device = await navigator.bluetooth.requestDevice({
          filters: [{ name: 'Dinosaur_Zone_Node' }],
          optionalServices: [ESP32_SERVICE_UUID]
        });

        statusText.innerText = 'Connecting...';
        await device.gatt.connect();
        statusText.innerText = 'Connected! Start walking.';
        document.getElementById('scanButton').style.display = 'none';

        if (!('watchAdvertisements' in device)) {
          statusText.innerText = "Error: Browser doesn't support live tracking.";
          return;
        }

        device.addEventListener('advertisementreceived', (event) => {
          let rawRssi = event.rssi;
          
          // --- NEW: Apply the Smoothing Math ---
          rssiHistory.push(rawRssi);
          if (rssiHistory.length > MAX_HISTORY) {
            rssiHistory.shift(); // Remove the oldest reading
          }
          
          // Calculate the average of the array
          let sum = rssiHistory.reduce((a, b) => a + b, 0);
          let avgRssi = sum / rssiHistory.length;
          
          let distance = calculateDistance(avgRssi);
          // -------------------------------------

          if(distance > 0) {
            distanceText.innerText = `Distance: ~${distance.toFixed(1)} meters`;
            hideAllZones(); 

            if (distance > 5.0) {
              document.getElementById('zoneFar').classList.add('active-zone');
              document.body.style.backgroundColor = "#f8d7da"; 
            } else if (distance >= 2.0 && distance <= 5.0) {
              document.getElementById('zoneNear').classList.add('active-zone');
              document.body.style.backgroundColor = "#fff3cd"; 
            } else if (distance < 2.0) {
              document.getElementById('zoneImmediate').classList.add('active-zone');
              document.body.style.backgroundColor = "#d4edda"; 
            }
          }
        });

        await device.watchAdvertisements();

        device.addEventListener('gattserverdisconnected', () => {
          statusText.innerText = 'Disconnected.';
          distanceText.innerText = 'Distance: -- meters';
          hideAllZones();
          document.body.style.backgroundColor = "white";
          document.getElementById('scanButton').style.display = 'inline-block';
        });

      } catch (error) {
        console.error(error);
        statusText.innerText = 'Connection failed. Try again.';
      }
    });
  </script>
