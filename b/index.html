<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Museum Exhibit Controller</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, sans-serif; 
            text-align: center; 
            padding: 30px; 
            background-color: #f4f4f9; color: #333;
        }
        button { 
            padding: 15px 30px; font-size: 18px; cursor: pointer; 
            border: none; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
            margin: 10px; transition: 0.2s;
        }
        #scanBtn { background-color: #2c3e50; color: white; }
        #onBtn { background-color: #27ae60; color: white; display: none; }
        #offBtn { background-color: #c0392b; color: white; display: none; }
        
        .distance-display { font-size: 20px; margin: 20px 0; font-weight: bold; }

        .option { 
            display: none; padding: 40px 20px; border-radius: 12px; margin-top: 30px; 
            font-size: 28px; color: white; transition: opacity 0.5s ease-in-out;
        }
        .active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        #state1 { background: #7f8c8d; } 
        #state2 { background: #3498db; } 
        #state3 { background: #2ecc71; } 
        #state4 { background: #e67e22; } 
        #state5 { background: #e74c3c; } 
    </style>
</head>
<body>

    <h1>Interactive Museum Explorer</h1>
    <button id="scanBtn">Connect to Exhibit</button>
    
    <div id="controls">
        <button id="onBtn">Turn Exhibit Light ON</button>
        <button id="offBtn">Turn Exhibit Light OFF</button>
    </div>

    <div class="distance-display">Estimated Distance: <span id="distanceLabel">--</span> meters</div>

    <div id="state1" class="option active">1. No exhibit nearby...</div>
    <div id="state2" class="option">2. Entering the zone.</div>
    <div id="state3" class="option">3. Getting closer...</div>
    <div id="state4" class="option">4. You can see the exhibit!</div>
    <div id="state5" class="option">5. You are in interaction range! Try the lights.</div>

    <script>
        const scanBtn = document.getElementById('scanBtn');
        const onBtn = document.getElementById('onBtn');
        const offBtn = document.getElementById('offBtn');
        const distanceLabel = document.getElementById('distanceLabel');
        const states = [
            document.getElementById('state1'), document.getElementById('state2'),
            document.getElementById('state3'), document.getElementById('state4'),
            document.getElementById('state5')
        ];

        let activeDevice = null;
        let ledCharacteristic = null; // Stores the "mailbox" connection
        
        // Smoothing variables
        let smoothedRssi = null;
        const alpha = 0.5; 

        scanBtn.addEventListener('click', async () => {
            try {
                scanBtn.innerText = "Connecting...";
                
                // 1. Find the device
                activeDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'ESP32' }], // Change to 'Dinosaur' if cache cleared
                    optionalServices: ['4fafc201-1fb5-459e-8fcc-c5c9c331914b']
                });

                // 2. CONNECT TO GATT SERVER (This is new!)
                const server = await activeDevice.gatt.connect();
                const service = await server.getPrimaryService('4fafc201-1fb5-459e-8fcc-c5c9c331914b');
                
                // 3. Get the specific characteristic to write to
                ledCharacteristic = await service.getCharacteristic('beb5483e-36e1-4688-b7f5-ea07361b26a8');

                scanBtn.innerText = `Connected!`;
                scanBtn.style.display = "none";
                
                // Show the control buttons
                onBtn.style.display = "inline-block";
                offBtn.style.display = "inline-block";

                // 4. Start watching distance in the background
                activeDevice.addEventListener('advertisementreceived', (event) => {
                    let currentRssi = event.rssi;
                    smoothedRssi = (smoothedRssi === null) ? currentRssi : (alpha * currentRssi) + ((1 - alpha) * smoothedRssi);
                    let ratio = (-59 - smoothedRssi) / (10 * 2.0);
                    let distance = Math.pow(10, ratio).toFixed(2);
                    
                    distanceLabel.innerText = distance;
                    updateUI(distance);
                });

                await activeDevice.watchAdvertisements();

            } catch (error) {
                console.error('Bluetooth Error: ', error);
                scanBtn.innerText = "Connection Failed. Try Again.";
            }
        });

        // --- NEW: Send Commands to the ESP32 ---
        
        onBtn.addEventListener('click', async () => {
            if (ledCharacteristic) {
                let encoder = new TextEncoder('utf-8');
                await ledCharacteristic.writeValue(encoder.encode('1'));
                console.log("Sent ON command");
            }
        });

        offBtn.addEventListener('click', async () => {
            if (ledCharacteristic) {
                let encoder = new TextEncoder('utf-8');
                await ledCharacteristic.writeValue(encoder.encode('0'));
                console.log("Sent OFF command");
            }
        });

        // Map distance to UI
        function updateUI(dist) {
            states.forEach(state => state.classList.remove('active'));
            if (dist > 5.0) states[0].classList.add('active');
            else if (dist > 3.0) states[1].classList.add('active');
            else if (dist > 1.5) states[2].classList.add('active');
            else if (dist > 0.5) states[3].classList.add('active');
            else states[4].classList.add('active');
        }
    </script>
</body>
</html>
