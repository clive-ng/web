<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
    <style>
        body { font-family: sans-serif; padding: 20px; line-height: 1.6; }
        pre { border-radius: 8px; overflow: hidden; }
    </style>
</head>
<body>

    <h3>Source Code Snippet</h3>
    <pre><code class="language-javascript">
    import React, { useState, useRef, useCallback, useEffect } from 'react';
import { 
  Upload, 
  Image as ImageIcon, 
  Wand2, 
  RefreshCw, 
  Download, 
  AlertCircle, 
  CheckCircle2, 
  Trash2, 
  Plus, 
  Hourglass,
  Loader2
} from 'lucide-react';

const App = () => {
  const [images, setImages] = useState([]);
  const [prompt, setPrompt] = useState(
    "Remove all the text and hand-drawn graphics from the girl's white shirt, making it a plain clean white shirt with blue collar and cuffs. IMPORTANT: Keep the original school logo on her dress. The new subject should look natural and photorealistic, with realistic skin texture, accurate facial proportions, and seamless blending into the scene. Match the original shadows, colour temperature, and perspective so the replacement is indistinguishable from the original photograph. High detail, sharp focus, professional photography quality."
  );
  const [isProcessing, setIsProcessing] = useState(false);
  const [downloadCount, setDownloadCount] = useState(1);
  const [globalError, setGlobalError] = useState(null);
  const fileInputRef = useRef(null);

  const apiKey = ""; // Provided by the environment

  // --- API Helper with Exponential Backoff ---
  const fetchWithRetry = async (url, options, retries = 5) => {
    const delays = [1000, 2000, 4000, 8000, 16000];
    for (let i = 0; i < retries; i++) {
      try {
        const response = await fetch(url, options);
        if (!response.ok) {
          const data = await response.json().catch(() => ({}));
          throw new Error(data.error?.message || `Status ${response.status}`);
        }
        return await response.json();
      } catch (err) {
        if (i === retries - 1) throw err;
        await new Promise(res => setTimeout(res, delays[i]));
      }
    }
  };

  const processFiles = (files) => {
    setGlobalError(null);
    const validFiles = Array.from(files).filter(f => f.type.startsWith('image/'));
    
    validFiles.forEach(file => {
      const reader = new FileReader();
      reader.onload = (e) => {
        setImages(prev => [...prev, {
          id: crypto.randomUUID(),
          dataUrl: e.target.result,
          resultUrl: null,
          status: 'idle', // idle, processing, done, error
          fileName: null,
          error: null
        }]);
      };
      reader.readAsDataURL(file);
    });
  };

  const handleDrop = (e) => {
    e.preventDefault();
    processFiles(e.dataTransfer.files);
  };

  const handleGenerateBatch = async () => {
    const pending = images.filter(img => img.status === 'idle' || img.status === 'error');
    if (pending.length === 0 || isProcessing) return;

    setIsProcessing(true);
    setGlobalError(null);

    let currentCounter = downloadCount;

    for (const img of pending) {
      // Set individual status to processing
      setImages(prev => prev.map(i => i.id === img.id ? { ...i, status: 'processing', error: null } : i));

      try {
        const base64Data = img.dataUrl.split(',')[1];
        const mimeType = img.dataUrl.match(/data:(.*?);base64/)[1];

        const payload = {
          contents: [{
            parts: [
              { text: prompt },
              { inlineData: { mimeType, data: base64Data } }
            ]
          }],
          generationConfig: {
            responseModalities: ["TEXT", "IMAGE"]
          }
        };

        // Attempting with the image-preview model first as it is designed for image editing
        const result = await fetchWithRetry(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          }
        );

        const outPart = result.candidates?.[0]?.content?.parts?.find(p => p.inlineData);
        if (outPart?.inlineData?.data) {
          const resultDataUrl = `data:image/png;base64,${outPart.inlineData.data}`;
          const finalFileName = `unit${String(currentCounter).padStart(3, '0')}.jpg`;
          
          setImages(prev => prev.map(i => i.id === img.id ? { 
            ...i, 
            status: 'done', 
            resultUrl: resultDataUrl, 
            fileName: finalFileName 
          } : i));

          // Trigger automatic download
          const link = document.createElement('a');
          link.href = resultDataUrl;
          link.download = finalFileName;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);

          currentCounter++;
        } else {
          throw new Error("No image data returned from AI. Try adjusting the prompt.");
        }
      } catch (err) {
        console.error("Processing error:", err);
        setImages(prev => prev.map(i => i.id === img.id ? { ...i, status: 'error', error: err.message } : i));
      }
    }

    setDownloadCount(currentCounter);
    setIsProcessing(false);
  };

  const removeImage = (id) => {
    if (isProcessing) return;
    setImages(prev => prev.filter(img => img.id !== id));
  };

  const finishedCount = images.filter(img => img.status === 'done' || img.status === 'error').length;
  const progressPercent = images.length > 0 ? (finishedCount / images.length) * 100 : 0;

  return (
    <div className="min-h-screen bg-slate-50 text-slate-900 p-4 md:p-8 font-sans">
      <div className="max-w-6xl mx-auto space-y-8">
        
        {/* Header Section */}
        <header className="text-center space-y-3">
          <div className="flex items-center justify-center gap-4">
            <div className="p-3 bg-indigo-600 rounded-2xl text-white shadow-xl">
              <Wand2 size={32} />
            </div>
            <h1 className="text-4xl font-extrabold tracking-tight text-slate-900">Batch Cleaner</h1>
          </div>
          <p className="text-slate-500 max-w-xl mx-auto text-lg">
            Sequential AI processing for garment cleaning. Upload multiple images, and they will be cleaned and numbered automatically.
          </p>
        </header>

        {globalError && (
          <div className="bg-red-50 border border-red-200 text-red-700 p-4 rounded-xl flex items-center gap-3 animate-in fade-in duration-300">
            <AlertCircle className="shrink-0" />
            <p className="text-sm font-medium">{globalError}</p>
          </div>
        )}

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
          
          {/* Left Column: Input and Configuration */}
          <div className="space-y-6">
            <section className="bg-white rounded-3xl shadow-sm border border-slate-200 p-6 space-y-4">
              <div className="flex justify-between items-center">
                <h2 className="text-lg font-bold flex items-center gap-2">
                  <ImageIcon size={20} className="text-indigo-600" />
                  Upload Queue ({images.length})
                </h2>
                {images.length > 0 && !isProcessing && (
                  <button 
                    onClick={() => setImages([])}
                    className="text-slate-400 hover:text-red-500 transition-colors text-sm font-semibold"
                  >
                    Clear All
                  </button>
                )}
              </div>

              <div 
                onDragOver={(e) => e.preventDefault()}
                onDrop={handleDrop}
                onClick={() => !isProcessing && fileInputRef.current?.click()}
                className={`relative group border-2 border-dashed rounded-2xl p-10 transition-all flex flex-col items-center justify-center gap-4 cursor-pointer
                  ${images.length === 0 ? 'min-h-[300px]' : 'min-h-[120px]'}
                  ${isProcessing ? 'cursor-not-allowed opacity-50' : 'hover:border-indigo-400 hover:bg-indigo-50 border-slate-200 bg-slate-50/50'}`}
              >
                <input 
                  type="file" 
                  multiple 
                  accept="image/*" 
                  className="hidden" 
                  ref={fileInputRef}
                  onChange={(e) => processFiles(e.target.files)}
                />
                
                <div className="p-4 bg-white rounded-full shadow-sm group-hover:scale-110 transition-transform">
                  <Upload className="text-slate-400 group-hover:text-indigo-600" />
                </div>
                <div className="text-center">
                  <p className="font-bold text-slate-700">Drop files here or click</p>
                  <p className="text-xs text-slate-400">Add multiple images to the processing queue</p>
                </div>
              </div>

              {images.length > 0 && (
                <div className="grid grid-cols-4 sm:grid-cols-5 gap-3 max-h-[320px] overflow-y-auto pr-2 custom-scrollbar">
                  {images.map(img => (
                    <div key={img.id} className="relative aspect-square rounded-xl overflow-hidden border border-slate-200 group bg-slate-100">
                      <img src={img.dataUrl} className="w-full h-full object-cover" alt="Preview" />
                      <div className={`absolute inset-0 flex items-center justify-center transition-all 
                        ${img.status === 'processing' ? 'bg-indigo-600/60' : 'opacity-0 group-hover:opacity-100 bg-black/40'}`}>
                        {img.status === 'processing' ? (
                          <Loader2 className="text-white animate-spin" />
                        ) : img.status === 'done' ? (
                          <CheckCircle2 className="text-emerald-400" />
                        ) : !isProcessing && (
                          <button 
                            onClick={(e) => { e.stopPropagation(); removeImage(img.id); }}
                            className="bg-red-500 text-white p-1.5 rounded-full hover:bg-red-600 shadow-md"
                          >
                            <Trash2 size={14} />
                          </button>
                        )}
                      </div>
                    </div>
                  ))}
                  <button 
                    onClick={(e) => { e.stopPropagation(); fileInputRef.current?.click(); }}
                    disabled={isProcessing}
                    className="aspect-square border-2 border-dashed border-slate-200 rounded-xl flex items-center justify-center text-slate-400 hover:bg-slate-50 disabled:opacity-50"
                  >
                    <Plus />
                  </button>
                </div>
              )}
            </section>

            <section className="bg-white rounded-3xl shadow-sm border border-slate-200 p-6 space-y-4">
              <h2 className="text-lg font-bold flex items-center gap-2">
                <Wand2 size={20} className="text-indigo-600" />
                Refinement Prompt
              </h2>
              <textarea 
                value={prompt}
                onChange={(e) => setPrompt(e.target.value)}
                disabled={isProcessing}
                className="w-full min-h-[140px] p-4 text-sm bg-slate-50 border border-slate-200 rounded-2xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all resize-none disabled:opacity-50"
              />
              <button 
                onClick={handleGenerateBatch}
                disabled={isProcessing || images.filter(i => i.status === 'idle').length === 0}
                className="w-full py-4 bg-indigo-600 hover:bg-indigo-700 disabled:bg-slate-200 text-white font-bold rounded-2xl shadow-xl shadow-indigo-200/50 transition-all flex items-center justify-center gap-3 active:scale-[0.98]"
              >
                {isProcessing ? (
                  <>
                    <RefreshCw className="animate-spin" size={20} />
                    Cleaning {images.filter(i => i.status === 'processing').length + images.filter(i => i.status === 'idle').length} Remaining...
                  </>
                ) : (
                  <>
                    <Wand2 size={20} />
                    Process {images.filter(i => i.status === 'idle').length || ''} Images
                  </>
                )}
              </button>
            </section>
          </div>

          {/* Right Column: Processing Results */}
          <section className="bg-white rounded-3xl shadow-sm border border-slate-200 p-6 flex flex-col min-h-[600px]">
            <div className="flex justify-between items-center mb-6">
              <h2 className="text-lg font-bold flex items-center gap-2 text-emerald-600">
                <CheckCircle2 size={20} />
                Results Gallery
              </h2>
              <span className="text-xs font-bold bg-emerald-50 text-emerald-700 px-4 py-1.5 rounded-full uppercase tracking-widest border border-emerald-100">
                {images.filter(i => i.status === 'done').length} Completed
              </span>
            </div>

            {isProcessing && (
              <div className="mb-6 space-y-3 animate-in fade-in duration-500">
                <div className="flex justify-between text-xs font-black text-indigo-600 uppercase tracking-widest px-1">
                  <span>Batch Progress</span>
                  <span>{finishedCount} / {images.length}</span>
                </div>
                <div className="w-full h-3 bg-indigo-50 rounded-full overflow-hidden border border-indigo-100 shadow-inner">
                  <div 
                    className="h-full bg-indigo-600 transition-all duration-700 ease-out shadow-[0_0_10px_rgba(79,70,229,0.5)]" 
                    style={{ width: `${progressPercent}%` }}
                  />
                </div>
              </div>
            )}

            <div className="flex-grow space-y-4 overflow-y-auto pr-1 custom-scrollbar">
              {images.length === 0 ? (
                <div className="h-full flex flex-col items-center justify-center text-slate-300 space-y-5">
                  <div className="p-8 bg-slate-50 rounded-full border border-slate-100 shadow-sm">
                    <ImageIcon size={56} />
                  </div>
                  <p className="font-semibold text-lg">Results will appear here</p>
                </div>
              ) : (
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-5">
                  {images.map(img => (
                    <div key={`res-${img.id}`} className="bg-slate-50 border border-slate-200 rounded-3xl p-4 flex flex-col gap-4 group transition-all hover:border-indigo-200 hover:bg-white hover:shadow-xl">
                      <div className="aspect-square rounded-2xl overflow-hidden bg-slate-200 relative flex items-center justify-center border border-slate-100">
                        {img.status === 'done' ? (
                          <img src={img.resultUrl} className="w-full h-full object-contain" alt="Result" />
                        ) : img.status === 'processing' ? (
                          <div className="flex flex-col items-center gap-3 text-indigo-500 font-bold text-sm">
                            <RefreshCw className="animate-spin" size={24} />
                            <span className="animate-pulse">Cleaning...</span>
                          </div>
                        ) : img.status === 'error' ? (
                          <div className="p-4 text-center space-y-2">
                            <AlertCircle className="mx-auto text-red-400" size={32} />
                            <p className="text-xs text-red-600 leading-relaxed font-bold">{img.error}</p>
                          </div>
                        ) : (
                          <div className="flex flex-col items-center gap-3 text-slate-400 font-bold text-xs uppercase tracking-widest opacity-40">
                            <Hourglass size={24} />
                            <span>Queued</span>
                            <span className="text-[10px] bg-slate-100 text-slate-500 px-2 py-1 rounded-lg">
                              Pos: {images.filter(i => i.status === 'idle').findIndex(i => i.id === img.id) + 1}
                            </span>
                          </div>
                        )}
                      </div>
                      <div className="flex items-center justify-between px-1">
                        <div className="flex flex-col min-w-0">
                          <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Filename</span>
                          <span className="text-sm font-bold text-slate-700 truncate">{img.fileName || 'Pending...'}</span>
                        </div>
                        {img.status === 'done' && (
                          <a 
                            href={img.resultUrl} 
                            download={img.fileName}
                            className="p-3 bg-emerald-50 text-emerald-600 rounded-xl hover:bg-emerald-600 hover:text-white transition-all shadow-sm border border-emerald-100"
                          >
                            <Download size={18} />
                          </a>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </section>
        </div>
      </div>
    </div>
  );
};

export default App;
    function helloGemini() {
        console.log("This is where your shared code goes!");
    }
    </code></pre>

</body>
</html>
