<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Batch Cleaner Pro 1.2 </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        @keyframes pulse-soft { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .animate-pulse-soft { animation: pulse-soft 2s infinite; }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef } = React;

        const App = () => {
            // SETTINGS
            const apiKey = "AIzaSyAw_XAEgiSNPXfduMG12c6UiXnmHOfln3c"; 
            const MODEL_NAME = "models/gemini-1.5-flash"; // Using full path for maximum compatibility

            const [images, setImages] = useState([]);
            const [prompt, setPrompt] = useState("Remove all text and handwriting from the dress. Make it a plain clean dress but keep the school logo. Photorealistic high quality.");
            const [namePrefix, setNamePrefix] = useState("unitf");
            const [downloadCount, setDownloadCount] = useState(1);
            const [zeroPadding, setZeroPadding] = useState(3);
            const [isProcessing, setIsProcessing] = useState(false);
            const [isDragging, setIsDragging] = useState(false);
            const fileInputRef = useRef(null);

            const processFiles = (files) => {
                Array.from(files).filter(f => f.type.startsWith('image/')).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        setImages(prev => [...prev, {
                            id: crypto.randomUUID(),
                            dataUrl: e.target.result,
                            status: 'idle',
                            fileName: null,
                            resultUrl: null,
                            error: null
                        }]);
                    };
                    reader.readAsDataURL(file);
                });
            };

            const handleGenerateBatch = async () => {
                const pending = images.filter(img => img.status === 'idle' || img.status === 'error');
                if (pending.length === 0 || isProcessing) return;

                setIsProcessing(true);
                let currentCounter = downloadCount;

                for (const img of pending) {
                    setImages(prev => prev.map(i => i.id === img.id ? { ...i, status: 'processing', error: null } : i));

                    try {
                        const base64Data = img.dataUrl.split(',')[1];
                        const mimeType = img.dataUrl.match(/data:(.*?);base64/)[1];

                        const response = await fetch(
                            `https://generativelanguage.googleapis.com/v1beta/${MODEL_NAME}:generateContent?key=${apiKey}`,
                            {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    contents: [{
                                        parts: [
                                            { text: prompt },
                                            { inlineData: { mimeType: mimeType, data: base64Data } }
                                        ]
                                    }]
                                    // Removed responseModalities as it causes errors on some API tiers
                                })
                            }
                        );

                        const data = await response.json();
                        
                        if (!response.ok) {
                            throw new Error(data.error?.message || "API Connection Failed");
                        }

                        // Gemini often returns the image in parts[1] or parts[0] depending on the prompt result
                        const outPart = data.candidates?.[0]?.content?.parts?.find(p => p.inlineData);
                        
                        if (outPart?.inlineData?.data) {
                            const resultUrl = `data:image/png;base64,${outPart.inlineData.data}`;
                            const finalFileName = `${namePrefix}${String(currentCounter).padStart(zeroPadding, '0')}.png`;
                            
                            setImages(prev => prev.map(i => i.id === img.id ? { 
                                ...i, status: 'done', resultUrl, fileName: finalFileName 
                            } : i));

                            const link = document.createElement('a');
                            link.href = resultUrl;
                            link.download = finalFileName;
                            link.click();

                            currentCounter++;
                            setDownloadCount(currentCounter);
                        } else {
                            const textResponse = data.candidates?.[0]?.content?.parts?.[0]?.text;
                            throw new Error(textResponse ? "AI gave text instead of image. Try a simpler prompt." : "No image generated.");
                        }
                    } catch (err) {
                        setImages(prev => prev.map(i => i.id === img.id ? { ...i, status: 'error', error: err.message } : i));
                    }
                }
                setIsProcessing(false);
            };

            return (
                <div className="min-h-screen p-4 md:p-8 max-w-5xl mx-auto space-y-6">
                    <header className="flex items-center gap-4 border-b pb-6 border-slate-200">
                        <div className="p-3 bg-indigo-600 rounded-2xl text-white shadow-lg"><i className="fa-solid fa-wand-magic-sparkles text-2xl"></i></div>
                        <div>
                            <h1 className="text-3xl font-black text-slate-800 leading-tight tracking-tight">AI Batch Cleaner</h1>
                            <p className="text-slate-400 text-[10px] font-bold uppercase tracking-[0.2em] mt-1">Status: Optimized for {MODEL_NAME}</p>
                        </div>
                    </header>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div className="space-y-6">
                            <section className="bg-white rounded-3xl shadow-sm border border-slate-200 p-6 space-y-4">
                                <div className="flex justify-between items-center font-bold">
                                    <span className="text-[10px] uppercase tracking-widest text-slate-400">Queue ({images.length})</span>
                                    {images.length > 0 && <button onClick={() => setImages([])} className="text-red-400 text-[10px] uppercase hover:underline">Clear All</button>}
                                </div>
                                <div 
                                    onDragOver={(e) => { e.preventDefault(); setIsDragging(true); }}
                                    onDragLeave={() => setIsDragging(false)}
                                    onDrop={(e) => { e.preventDefault(); setIsDragging(false); processFiles(e.dataTransfer.files); }}
                                    onClick={() => !isProcessing && fileInputRef.current?.click()}
                                    className={`border-2 border-dashed rounded-2xl p-10 text-center cursor-pointer transition-all
                                    ${isDragging ? 'border-indigo-500 bg-indigo-50' : 'border-slate-200 bg-slate-50 hover:bg-slate-100'}
                                    ${isProcessing ? 'opacity-50 pointer-events-none' : ''}`}>
                                    <input type="file" multiple accept="image/*" className="hidden" ref={fileInputRef} onChange={(e) => processFiles(e.target.files)} />
                                    <i className={`fa-solid ${isDragging ? 'fa-hand-sparkles' : 'fa-cloud-arrow-up'} text-3xl text-slate-300 mb-2`}></i>
                                    <p className="text-slate-600 font-bold text-sm">Drag & Drop or Click</p>
                                </div>
                            </section>

                            <section className="bg-white rounded-3xl shadow-sm border border-slate-200 p-6 space-y-4">
                                <div className="grid grid-cols-3 gap-4">
                                    <div><label className="text-[9px] font-black text-slate-400 uppercase tracking-widest">Prefix</label><input type="text" value={namePrefix} onChange={(e) => setNamePrefix(e.target.value)} className="w-full p-2 bg-slate-50 border rounded-xl font-bold outline-indigo-500 text-sm" /></div>
                                    <div><label className="text-[9px] font-black text-slate-400 uppercase tracking-widest">Start #</label><input type="number" value={downloadCount} onChange={(e) => setDownloadCount(parseInt(e.target.value))} className="w-full p-2 bg-slate-50 border rounded-xl font-bold outline-indigo-500 text-sm" /></div>
                                    <div><label className="text-[9px] font-black text-slate-400 uppercase tracking-widest">Digits</label><select value={zeroPadding} onChange={(e) => setZeroPadding(parseInt(e.target.value))} className="w-full p-2 bg-slate-50 border rounded-xl font-bold outline-indigo-500 text-sm"><option value="1">1</option><option value="2">01</option><option value="3">001</option></select></div>
                                </div>
                                <textarea value={prompt} onChange={(e) => setPrompt(e.target.value)} className="w-full min-h-[80px] p-4 text-xs bg-slate-50 border rounded-2xl font-medium outline-none focus:ring-1 focus:ring-indigo-500" />
                                <button onClick={handleGenerateBatch} disabled={isProcessing || images.length === 0}
                                    className="w-full py-4 bg-indigo-600 hover:bg-indigo-700 disabled:bg-slate-200 text-white font-black rounded-2xl shadow-xl transition-all flex items-center justify-center gap-3">
                                    {isProcessing ? <><i className="fa-solid fa-circle-notch fa-spin"></i> Processing...</> : <><i className="fa-solid fa-bolt"></i> Run Batch</>}
                                </button>
                            </section>
                        </div>

                        <section className="bg-white rounded-3xl shadow-sm border border-slate-200 p-6 flex flex-col min-h-[500px]">
                            <h2 className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-6">Output</h2>
                            <div className="flex-grow overflow-y-auto custom-scrollbar">
                                {images.length === 0 ? (
                                    <div className="h-full flex flex-col items-center justify-center text-slate-300 opacity-40 italic text-sm"><p>No images in queue</p></div>
                                ) : (
                                    <div className="grid grid-cols-2 gap-4">
                                        {images.map(img => (
                                            <div key={img.id} className="bg-slate-50 border border-slate-200 rounded-2xl p-3 space-y-3 relative group transition-all hover:bg-white hover:border-indigo-100">
                                                <div className="aspect-square rounded-xl overflow-hidden bg-slate-200 flex items-center justify-center border relative">
                                                    {img.status === 'done' ? <img src={img.resultUrl} className="w-full h-full object-contain" /> :
                                                     img.status === 'processing' ? <div className="text-center animate-pulse-soft"><i className="fa-solid fa-sync fa-spin text-indigo-500 text-xl mb-1"></i><p className="text-[8px] font-black text-indigo-500 uppercase">AI Working</p></div> :
                                                     img.status === 'error' ? <div className="p-2 text-[8px] text-red-500 font-bold text-center leading-tight"><i className="fa-solid fa-triangle-exclamation text-lg mb-1"></i><br/>{img.error}</div> :
                                                     <img src={img.dataUrl} className="w-full h-full object-cover opacity-20 grayscale" />}
                                                </div>
                                                <div className="flex items-center justify-between px-1">
                                                    <p className="text-[9px] font-bold text-slate-400 truncate max-w-[80px]">{img.fileName || 'Queued'}</p>
                                                    {img.status === 'done' && <i className="fa-solid fa-circle-check text-emerald-500 text-xs"></i>}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </section>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
