<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Museum Wayfinding</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; }
    button { padding: 15px 30px; font-size: 18px; background-color: #007BFF; color: white; border: none; border-radius: 8px; cursor: pointer; margin-bottom: 20px; }
    .data-box { margin-top: 30px; padding: 20px; background-color: #f4f4f4; border-radius: 8px; }
    h1 { font-size: 24px; }
    .warning { color: red; font-size: 14px; font-weight: bold; }
  </style>
</head>
<body>

  <h1>Dinosaur Exhibit Navigator</h1>
  <p>Click the button below to connect to the exhibit.</p>
  
  <button id="scanButton">Scan & Connect</button>

  <div class="data-box">
    <h3 id="statusText">Status: Waiting...</h3>
    <h2 id="distanceText">Distance: -- meters</h2>
    <p id="rssiText">Signal Strength (RSSI): --</p>
  </div>
  <p id="errorMessage" class="warning"></p>

  <script>
    function calculateDistance(rssi) {
      const txPower = -59; 
      if (rssi === 0) return -1.0; 
      const ratio = rssi * 1.0 / txPower;
      if (ratio < 1.0) {
        return Math.pow(ratio, 10);
      } else {
        return (0.89976) * Math.pow(ratio, 7.7095) + 0.111;    
      }
    }

    document.getElementById('scanButton').addEventListener('click', async () => {
      const statusText = document.getElementById('statusText');
      const errorText = document.getElementById('errorMessage');
      errorText.innerText = ""; // Clear old errors

      try {
        statusText.innerText = 'Status: Scanning...';

        // 1. Request the device
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ name: 'Dinosaur_Zone_Node' }]
        });

        statusText.innerText = 'Status: Device found, connecting...';

        // 2. CRITICAL FIX: Connect to the GATT server!
        // This tells the OS "Keep this connection alive, do not go to sleep."
        await device.gatt.connect();
        statusText.innerText = 'Status: Connected to ' + device.name;

        // Handle accidental disconnects (e.g., walking too far away)
        device.addEventListener('gattserverdisconnected', () => {
          statusText.innerText = 'Status: Disconnected. Please scan again.';
          document.body.style.backgroundColor = "white";
        });

        // 3. Check for watchAdvertisements compatibility (Crucial for iOS/Bluefy)
        if (!('watchAdvertisements' in device)) {
          errorText.innerText = "Error: Your browser does not support continuous distance tracking (watchAdvertisements API).";
          return; // Stop the script here so it doesn't crash
        }

        // 4. Listen for signal strength updates
        device.addEventListener('advertisementreceived', (event) => {
          let currentRssi = event.rssi;
          let estimatedDistance = calculateDistance(currentRssi).toFixed(2);

          document.getElementById('rssiText').innerText = `Signal Strength (RSSI): ${currentRssi} dBm`;
          document.getElementById('distanceText').innerText = `Distance: ~${estimatedDistance} meters`;
          
          if(estimatedDistance < 2.0 && estimatedDistance > 0) {
            document.body.style.backgroundColor = "#d4edda"; 
          } else {
            document.body.style.backgroundColor = "white";
          }
        });

        // Start watching the signals
        await device.watchAdvertisements();

      } catch (error) {
        console.error(error);
        statusText.innerText = 'Status: Error occurred.';
        errorText.innerText = error.message;
      }
    });
  </script>

</body>
</html>
