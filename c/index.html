<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Batch Cleaner Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #cbd5e1; }
        @keyframes pulse-soft { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .animate-pulse-soft { animation: pulse-soft 2s infinite; }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef } = React;

        const App = () => {
            // --- CONFIGURATION ---
            const apiKey = "AIzaSyAw_XAEgiSNPXfduMG12c6UiXnmHOfln3c"; 
            const MODEL_ENDPOINT = "gemini-2.0-flash";

            const [images, setImages] = useState([]);
            const [prompt, setPrompt] = useState(
                "Remove all the text, hand-drawn graphics, hand writing from the girl's dress and collar, making it a plain clean dress but leave the blue or red ribbon if it has. IMPORTANT: make sure all of the text are remove. Keep the original school logo on her dress. The new subject should look natural and photorealistic, with realistic skin texture, accurate facial proportions, and seamless blending into the scene. Match the original shadows, colour temperature, and perspective so the replacement is indistinguishable from the original photograph. High detail, sharp focus, professional photography quality."
            );
            
            const [namePrefix, setNamePrefix] = useState("unitf");
            const [downloadCount, setDownloadCount] = useState(1);
            const [zeroPadding, setZeroPadding] = useState(3);
            const [isProcessing, setIsProcessing] = useState(false);
            const fileInputRef = useRef(null);

            // --- API Helper ---
            const fetchWithRetry = async (url, options, retries = 3) => {
                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch(url, options);
                        const data = await response.json();
                        if (!response.ok) throw new Error(data.error?.message || "API Error");
                        return data;
                    } catch (err) {
                        if (i === retries - 1) throw err;
                        await new Promise(res => setTimeout(res, 2000));
                    }
                }
            };

            const processFiles = (files) => {
                const validFiles = Array.from(files).filter(f => f.type.startsWith('image/'));
                validFiles.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        setImages(prev => [...prev, {
                            id: crypto.randomUUID(),
                            dataUrl: e.target.result,
                            status: 'idle',
                            fileName: null,
                            resultUrl: null,
                            error: null
                        }]);
                    };
                    reader.readAsDataURL(file);
                });
            };

            const handleGenerateBatch = async () => {
                const pending = images.filter(img => img.status === 'idle' || img.status === 'error');
                if (pending.length === 0 || isProcessing) return;

                setIsProcessing(true);
                let currentCounter = downloadCount;

                for (const img of pending) {
                    setImages(prev => prev.map(i => i.id === img.id ? { ...i, status: 'processing', error: null } : i));

                    try {
                        const base64Data = img.dataUrl.split(',')[1];
                        const mimeType = img.dataUrl.match(/data:(.*?);base64/)[1];

                        const result = await fetchWithRetry(
                            `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_ENDPOINT}:generateContent?key=${apiKey}`,
                            {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    contents: [{
                                        parts: [{ text: prompt }, { inlineData: { mimeType, data: base64Data } }]
                                    }],
                                    generationConfig: { responseModalities: ["TEXT", "IMAGE"] }
                                })
                            }
                        );

                        const outPart = result.candidates?.[0]?.content?.parts?.find(p => p.inlineData);
                        if (outPart?.inlineData?.data) {
                            const resultUrl = `data:image/png;base64,${outPart.inlineData.data}`;
                            const finalFileName = `${namePrefix}${String(currentCounter).padStart(zeroPadding, '0')}.png`;
                            
                            setImages(prev => prev.map(i => i.id === img.id ? { 
                                ...i, status: 'done', resultUrl, fileName: finalFileName 
                            } : i));

                            const link = document.createElement('a');
                            link.href = resultUrl;
                            link.download = finalFileName;
                            link.click();

                            currentCounter++;
                            setDownloadCount(currentCounter);
                        } else {
                            throw new Error("No image returned. Try simplifying prompt.");
                        }
                    } catch (err) {
                        setImages(prev => prev.map(i => i.id === img.id ? { ...i, status: 'error', error: err.message } : i));
                    }
                }
                setIsProcessing(false);
            };

            return (
                <div className="min-h-screen p-4 md:p-8 max-w-6xl mx-auto space-y-8">
                    <header className="flex items-center gap-4">
                        <div className="p-3 bg-indigo-600 rounded-2xl text-white shadow-lg">
                            <i className="fa-solid fa-wand-sparkles text-2xl"></i>
                        </div>
                        <div>
                            <h1 className="text-3xl font-black text-slate-800 tracking-tight">Batch Cleaner</h1>
                            <p className="text-slate-400 text-sm font-bold uppercase tracking-widest">Model Active: {MODEL_ENDPOINT}</p>
                        </div>
                    </header>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div className="space-y-6">
                            {/* Upload Area */}
                            <section className="bg-white rounded-3xl shadow-sm border border-slate-200 p-6 space-y-4">
                                <div className="flex justify-between items-center font-bold">
                                    <span><i className="fa-solid fa-images text-indigo-500 mr-2"></i> Queue ({images.length})</span>
                                    {images.length > 0 && <button onClick={() => setImages([])} className="text-red-400 text-xs uppercase hover:underline">Clear All</button>}
                                </div>
                                <div onClick={() => !isProcessing && fileInputRef.current?.click()}
                                    className={`border-2 border-dashed rounded-2xl p-10 text-center cursor-pointer transition-all
                                    ${isProcessing ? 'opacity-50 grayscale' : 'hover:border-indigo-400 hover:bg-indigo-50 border-slate-200 bg-slate-50'}`}>
                                    <input type="file" multiple accept="image/*" className="hidden" ref={fileInputRef} onChange={(e) => processFiles(e.target.files)} />
                                    <i className="fa-solid fa-cloud-arrow-up text-3xl text-slate-300 mb-2"></i>
                                    <p className="text-slate-600 font-bold">Select or Drop Images</p>
                                </div>
                            </section>

                            {/* Batch Settings */}
                            <section className="bg-white rounded-3xl shadow-sm border border-slate-200 p-6">
                                <h3 className="font-black text-[10px] text-slate-400 uppercase tracking-[0.2em] mb-4">Naming Convention</h3>
                                <div className="grid grid-cols-3 gap-4">
                                    <div>
                                        <label className="text-[10px] font-bold text-slate-500 block mb-1 uppercase text-xs">Prefix</label>
                                        <input type="text" value={namePrefix} onChange={(e) => setNamePrefix(e.target.value)} className="w-full p-2 bg-slate-50 border rounded-xl text-sm font-bold outline-indigo-500" />
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-bold text-slate-500 block mb-1 uppercase text-xs">Start At</label>
                                        <input type="number" value={downloadCount} onChange={(e) => setDownloadCount(parseInt(e.target.value))} className="w-full p-2 bg-slate-50 border rounded-xl text-sm font-bold outline-indigo-500" />
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-bold text-slate-500 block mb-1 uppercase text-xs">Digits</label>
                                        <select value={zeroPadding} onChange={(e) => setZeroPadding(parseInt(e.target.value))} className="w-full p-2 bg-slate-50 border rounded-xl text-sm font-bold outline-indigo-500">
                                            <option value="1">1</option><option value="2">01</option><option value="3">001</option><option value="4">0001</option>
                                        </select>
                                    </div>
                                </div>
                            </section>

                            {/* Action Prompt */}
                            <section className="bg-white rounded-3xl shadow-sm border border-slate-200 p-6 space-y-4">
                                <h3 className="font-black text-[10px] text-slate-400 uppercase tracking-[0.2em] text-xs">Instructions</h3>
                                <textarea value={prompt} onChange={(e) => setPrompt(e.target.value)} className="w-full min-h-[120px] p-4 text-xs bg-slate-50 border rounded-2xl font-medium leading-relaxed outline-indigo-500" />
                                <button onClick={handleGenerateBatch} disabled={isProcessing || images.length === 0}
                                    className="w-full py-5 bg-indigo-600 hover:bg-indigo-700 disabled:bg-slate-200 text-white font-black rounded-2xl shadow-xl transition-all flex items-center justify-center gap-3 active:scale-95">
                                    {isProcessing ? <><i className="fa-solid fa-spinner fa-spin"></i> Processing...</> : <><i className="fa-solid fa-bolt"></i> Run Batch Process</>}
                                </button>
                            </section>
                        </div>

                        {/* Gallery Section */}
                        <section className="bg-white rounded-3xl shadow-sm border border-slate-200 p-6 flex flex-col min-h-[600px]">
                            <h2 className="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2">
                                <i className="fa-solid fa-layer-group text-emerald-500"></i> Results Gallery
                            </h2>
                            <div className="flex-grow overflow-y-auto custom-scrollbar pr-2">
                                {images.length === 0 ? (
                                    <div className="h-full flex flex-col items-center justify-center text-slate-300 opacity-50">
                                        <i className="fa-solid fa-circle-nodes text-6xl mb-4"></i>
                                        <p className="font-bold">Waiting for input...</p>
                                    </div>
                                ) : (
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        {images.map(img => (
                                            <div key={img.id} className="bg-slate-50 border border-slate-200 rounded-3xl p-4 space-y-4 relative group hover:bg-white hover:border-indigo-100 transition-all">
                                                <div className="aspect-square rounded-2xl overflow-hidden bg-slate-200 flex items-center justify-center border">
                                                    {img.status === 'done' ? <img src={img.resultUrl} className="w-full h-full object-contain" /> :
                                                     img.status === 'processing' ? <div className="text-center animate-pulse-soft"><i className="fa-solid fa-sync fa-spin text-indigo-500 text-3xl mb-2"></i><p className="text-[10px] font-black text-indigo-500 uppercase">Cleaning...</p></div> :
                                                     img.status === 'error' ? <div className="p-4 text-center"><i className="fa-solid fa-triangle-exclamation text-red-400 mb-1 text-2xl"></i><p className="text-[10px] text-red-600 font-bold leading-tight">{img.error}</p></div> :
                                                     <i className="fa-solid fa-hourglass text-slate-300 text-2xl"></i>}
                                                </div>
                                                <div className="flex items-center justify-between">
                                                    <div className="min-w-0">
                                                        <p className="text-[9px] font-black text-slate-400 uppercase tracking-widest">Output Name</p>
                                                        <p className="text-xs font-bold text-slate-700 truncate">{img.fileName || 'Pending...'}</p>
                                                    </div>
                                                    {img.status === 'done' && (
                                                        <a href={img.resultUrl} download={img.fileName} className="h-10 w-10 bg-white shadow-sm border rounded-xl flex items-center justify-center text-emerald-500 hover:bg-emerald-500 hover:text-white transition-all">
                                                            <i className="fa-solid fa-download"></i>
                                                        </a>
                                                    )}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </section>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
