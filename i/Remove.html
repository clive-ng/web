<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Batch Garment Cleaner</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    /* Custom Animations */
    @keyframes fadeInSlide {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-in {
      animation: fadeInSlide 0.3s ease-out forwards;
    }
  </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-800 font-sans p-6 md:p-10">
  <div class="max-w-6xl mx-auto">
    
    <!-- Header -->
    <header class="mb-10 text-center">
      <h1 class="text-4xl font-extrabold tracking-tight text-slate-900 mb-2 flex items-center justify-center gap-3">
        <i data-lucide="wand-2" class="w-10 h-10 text-indigo-600"></i>
        AI Batch Garment Cleaner
      </h1>
      <p class="text-slate-500 text-lg max-w-2xl mx-auto">
        Upload multiple images at once. The AI will clean them sequentially and auto-download the results perfectly numbered.
      </p>
    </header>

    <!-- Global Error Display -->
    <div id="global-error" class="hidden mb-6 p-4 bg-red-50 border-l-4 border-red-500 rounded-md flex items-start gap-3 text-red-700 animate-in">
      <i data-lucide="alert-circle" class="w-5 h-5 shrink-0 mt-0.5"></i>
      <p id="global-error-text"></p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      
      <!-- Left Column: Input & Settings -->
      <div class="flex flex-col gap-6">
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 flex flex-col min-h-[400px]">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold flex items-center gap-2">
              <i data-lucide="image" class="w-5 h-5 text-indigo-500"></i>
              Original Images (<span id="images-count">0</span>)
            </h2>
            <button id="btn-clear-all" class="hidden text-sm text-slate-500 hover:text-red-500 flex items-center gap-1 transition-colors disabled:opacity-50">
              <i data-lucide="trash-2" class="w-4 h-4"></i> Clear All
            </button>
          </div>
          
          <div id="dropzone" class="flex-grow border-3 border-dashed rounded-xl p-4 flex flex-col items-center justify-center transition-colors border-slate-300 bg-slate-50 hover:bg-slate-100 min-h-[300px]">
            <input type="file" id="file-input" accept="image/*" multiple class="hidden">

            <!-- Empty State Dropzone -->
            <div id="empty-state" class="text-center cursor-pointer flex flex-col items-center w-full h-full justify-center">
              <div class="bg-white p-4 rounded-full shadow-sm mb-4">
                <i data-lucide="upload-cloud" id="upload-icon" class="w-8 h-8 text-slate-400"></i>
              </div>
              <p class="text-lg font-medium text-slate-700 mb-1">Drag & Drop images here</p>
              <p class="text-sm text-slate-500">or click to select multiple files</p>
            </div>

            <!-- Image Gallery -->
            <div id="image-gallery" class="hidden w-full grid grid-cols-3 sm:grid-cols-4 gap-3 self-start">
              <!-- Rendered via JS -->
            </div>
          </div>
        </div>

        <!-- Prompt Editor -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
          <h2 class="text-xl font-semibold mb-4">Editing Prompt</h2>
          <textarea id="prompt-input" class="w-full h-32 p-4 text-sm bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none resize-none transition-all disabled:opacity-75" placeholder="Describe what you want to change...">Remove all the text and hand-drawn graphics from the girl's white shirt, making it a plain clean white shirt with blue collar and cuffs. IF there is a distinct official school logo, keep it. The new subject should look natural and photorealistic, with realistic skin texture, accurate facial proportions, and seamless blending into the scene. Match the original shadows, colour temperature, and perspective so the replacement is indistinguishable from the original photograph. High detail, sharp focus, professional photography quality.</textarea>
          
          <button id="btn-generate" disabled class="w-full mt-4 py-3 px-6 rounded-xl font-semibold flex items-center justify-center gap-2 transition-all bg-slate-100 text-slate-400 cursor-not-allowed">
            <i data-lucide="wand-2" id="generate-icon" class="w-5 h-5"></i>
            <span id="generate-text">Clean Images</span>
          </button>
        </div>
      </div>

      <!-- Right Column: Output -->
      <div class="flex flex-col h-full">
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 flex-grow flex flex-col">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold flex items-center gap-2">
              <i data-lucide="check-circle-2" class="w-5 h-5 text-emerald-500"></i>
              Results (<span id="results-count">0</span>)
            </h2>
          </div>
          
          <!-- Progress Bar -->
          <div id="progress-container" class="hidden mb-4 bg-indigo-50 p-4 rounded-xl border border-indigo-100 animate-in">
            <div class="flex justify-between text-sm mb-2 font-medium text-indigo-900">
              <span class="flex items-center gap-2">
                <i data-lucide="refresh-cw" class="w-4 h-4 animate-spin text-indigo-600"></i> 
                Processing Batch...
              </span>
              <span id="progress-text">0 / 0 Completed</span>
            </div>
            <div class="w-full bg-indigo-200/50 rounded-full h-2.5 overflow-hidden">
              <div id="progress-bar" class="bg-indigo-600 h-2.5 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
            </div>
          </div>

          <div class="flex-grow border-2 border-slate-100 rounded-xl bg-slate-50 p-4 overflow-y-auto max-h-[700px]">
            
            <!-- Empty Results State -->
            <div id="empty-results" class="h-full flex flex-col items-center justify-center text-slate-400">
              <i data-lucide="image" class="w-12 h-12 mb-3 opacity-50"></i>
              <p>Your processed images will appear here</p>
            </div>

            <!-- Results Gallery -->
            <div id="results-gallery" class="hidden grid grid-cols-1 sm:grid-cols-2 gap-4">
              <!-- Rendered via JS -->
            </div>

          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    // --- State Variables ---
    let images = [];
    let isGenerating = false;
    let downloadCount = 1;
    const apiKey = ""; // Base variable required by environment rules
    
    // --- DOM Elements ---
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('file-input');
    const emptyState = document.getElementById('empty-state');
    const imageGallery = document.getElementById('image-gallery');
    const uploadIcon = document.getElementById('upload-icon');
    
    const apiKey = "AIzaSyAw_XAEgiSNPXfduMG12c6UiXnmHOfln3c"

    const btnClearAll = document.getElementById('btn-clear-all');
    const btnGenerate = document.getElementById('btn-generate');
    const generateIcon = document.getElementById('generate-icon');
    const generateText = document.getElementById('generate-text');
    const promptInput = document.getElementById('prompt-input');
    
    const imagesCount = document.getElementById('images-count');
    const resultsCount = document.getElementById('results-count');
    
    const globalError = document.getElementById('global-error');
    const globalErrorText = document.getElementById('global-error-text');
    
    const progressContainer = document.getElementById('progress-container');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    
    const emptyResults = document.getElementById('empty-results');
    const resultsGallery = document.getElementById('results-gallery');

    // Initialize Icons
    lucide.createIcons();

    // --- Helper Functions ---
    const showError = (msg) => {
      if (msg) {
        globalErrorText.innerText = msg;
        globalError.classList.remove('hidden');
      } else {
        globalError.classList.add('hidden');
      }
    };

    const updateUI = () => {
      const pendingCount = images.filter(img => img.status === 'idle' || img.status === 'error').length;
      const processedCount = images.filter(img => img.status === 'done').length;
      const finishedCount = images.filter(img => img.status === 'done' || img.status === 'error').length;
      const progressPercent = images.length > 0 ? Math.round((finishedCount / images.length) * 100) : 0;

      // Update Counts
      imagesCount.innerText = images.length;
      resultsCount.innerText = processedCount;

      // Toggle Clear All Button
      if (images.length > 0) {
        btnClearAll.classList.remove('hidden');
        btnClearAll.disabled = isGenerating;
      } else {
        btnClearAll.classList.add('hidden');
      }

      // Toggle Galleries vs Empty States
      if (images.length === 0) {
        emptyState.classList.remove('hidden');
        imageGallery.classList.add('hidden');
        dropzone.classList.add('min-h-[300px]');
        
        emptyResults.classList.remove('hidden');
        resultsGallery.classList.add('hidden');
      } else {
        emptyState.classList.add('hidden');
        imageGallery.classList.remove('hidden');
        dropzone.classList.remove('min-h-[300px]');
        
        emptyResults.classList.add('hidden');
        resultsGallery.classList.remove('hidden');
      }

      // Generate Button State
      const promptValue = promptInput.value.trim();
      if (pendingCount === 0 || isGenerating || !promptValue) {
        btnGenerate.disabled = true;
        btnGenerate.className = "w-full mt-4 py-3 px-6 rounded-xl font-semibold flex items-center justify-center gap-2 transition-all bg-slate-100 text-slate-400 cursor-not-allowed";
      } else {
        btnGenerate.disabled = false;
        btnGenerate.className = "w-full mt-4 py-3 px-6 rounded-xl font-semibold flex items-center justify-center gap-2 transition-all bg-indigo-600 hover:bg-indigo-700 text-white shadow-md hover:shadow-lg active:scale-[0.98]";
      }

      if (isGenerating) {
        generateIcon.setAttribute('data-lucide', 'refresh-cw');
        generateIcon.classList.add('animate-spin');
        generateText.innerText = `Processing ${pendingCount} Images...`;
      } else {
        generateIcon.setAttribute('data-lucide', 'wand-2');
        generateIcon.classList.remove('animate-spin');
        generateText.innerText = `Clean ${pendingCount > 0 ? pendingCount : ''} ${pendingCount === 1 ? 'Image' : 'Images'}`;
      }
      
      promptInput.disabled = isGenerating;

      // Progress Bar
      if (isGenerating && images.length > 0) {
        progressContainer.classList.remove('hidden');
        progressText.innerText = `${finishedCount} / ${images.length} Completed`;
        progressBar.style.width = `${progressPercent}%`;
      } else {
        progressContainer.classList.add('hidden');
      }

      renderGallery();
      renderResults();
      lucide.createIcons(); // Re-initialize icons for newly added HTML
    };

    // --- Render Functions ---
    const renderGallery = () => {
      let html = '';
      images.forEach(img => {
        let overlayHTML = `
          <div class="absolute top-1 left-1 bg-slate-700/80 backdrop-blur text-white text-xs px-2 py-1 rounded shadow-sm flex items-center gap-1">
            <i data-lucide="hourglass" class="w-3 h-3"></i> Queued
          </div>`;
        
        if (img.status === 'processing') {
          overlayHTML = `<div class="absolute top-1 left-1 bg-indigo-500 text-white text-xs px-2 py-1 rounded shadow-sm">Processing</div>`;
        } else if (img.status === 'done') {
          overlayHTML = `<div class="absolute top-1 left-1 bg-emerald-500 text-white text-xs px-2 py-1 rounded shadow-sm">Done</div>`;
        } else if (!isGenerating) {
          overlayHTML = ''; // No overlay if idle and not generating
        }

        html += `
          <div class="relative aspect-square rounded-lg overflow-hidden group border border-slate-200 shadow-sm bg-white">
            <img src="${img.dataUrl}" class="w-full h-full object-cover" />
            <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
              <button onclick="removeImage('${img.id}')" ${isGenerating ? 'disabled' : ''} class="bg-red-500 text-white p-2 rounded-full hover:bg-red-600 transition-colors disabled:opacity-50">
                <i data-lucide="trash-2" class="w-4 h-4"></i>
              </button>
            </div>
            ${overlayHTML}
          </div>
        `;
      });

      // Add "Add More" Button
      html += `
        <button onclick="document.getElementById('file-input').click()" ${isGenerating ? 'disabled' : ''} class="aspect-square rounded-lg border-2 border-dashed border-slate-300 flex flex-col items-center justify-center text-slate-400 hover:text-indigo-500 hover:border-indigo-400 hover:bg-indigo-50 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
          <i data-lucide="plus" class="w-8 h-8 mb-1"></i>
          <span class="text-xs font-medium">Add More</span>
        </button>
      `;

      imageGallery.innerHTML = html;
    };

    const renderResults = () => {
      let html = '';
      images.forEach((img, index) => {
        let contentHTML = '';
        
        if (img.status === 'done') {
          contentHTML = `<img src="${img.resultDataUrl}" class="w-full h-full object-cover" />`;
        } else if (img.status === 'processing') {
          contentHTML = `
            <div class="flex flex-col items-center text-indigo-500">
              <i data-lucide="wand-2" class="w-8 h-8 animate-bounce mb-2"></i>
              <span class="text-sm font-medium animate-pulse">Processing...</span>
            </div>`;
        } else if (img.status === 'error') {
          contentHTML = `
            <div class="flex flex-col items-center text-red-400 text-center p-4">
              <i data-lucide="alert-circle" class="w-8 h-8 mb-2"></i>
              <span class="text-xs">${img.errorText}</span>
            </div>`;
        } else {
          // Idle status
          if (isGenerating) {
            const queuePosition = images.filter(i => i.status === 'idle').findIndex(i => i.id === img.id) + 1;
            contentHTML = `
              <div class="flex flex-col items-center text-slate-400">
                <i data-lucide="hourglass" class="w-8 h-8 mb-2 opacity-50"></i>
                <span class="text-sm font-medium text-slate-500">In Queue</span>
                <span class="text-xs mt-1 bg-slate-200 text-slate-600 px-2 py-0.5 rounded-full font-semibold">Position: ${queuePosition}</span>
              </div>`;
          } else {
            contentHTML = `
              <div class="flex flex-col items-center text-slate-400">
                <i data-lucide="image" class="w-8 h-8 mb-2 opacity-30"></i>
                <span class="text-sm font-medium">Ready</span>
              </div>`;
          }
        }

        const fileNameDisplay = img.status === 'done' ? img.fileName : '---';
        const downloadBtnHTML = img.status === 'done' ? `
          <a href="${img.resultDataUrl}" download="${img.fileName}" class="text-emerald-600 hover:text-emerald-700 bg-emerald-50 hover:bg-emerald-100 px-3 py-1.5 rounded text-xs font-medium transition-colors flex items-center gap-1">
            <i data-lucide="download" class="w-3 h-3"></i> Save Again
          </a>
        ` : '';

        html += `
          <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-3 flex flex-col gap-3">
            <div class="aspect-square bg-slate-100 rounded flex items-center justify-center overflow-hidden relative">
              ${contentHTML}
            </div>
            <div class="flex items-center justify-between px-1">
              <span class="text-xs font-medium text-slate-500 truncate max-w-[100px]">${fileNameDisplay}</span>
              ${downloadBtnHTML}
            </div>
          </div>
        `;
      });

      resultsGallery.innerHTML = html;
    };


    // --- File Handling ---
    const processFiles = async (files) => {
      showError(null);
      const validFiles = files.filter(f => f.type.startsWith('image/'));
      
      if (validFiles.length === 0) {
        showError("Please drop valid image files.");
        return;
      }

      for (const file of validFiles) {
        const reader = new FileReader();
        reader.onload = (event) => {
          images.push({
            id: crypto.randomUUID(),
            dataUrl: event.target.result,
            resultDataUrl: null,
            status: 'idle',
            errorText: null,
            fileName: null
          });
          updateUI();
        };
        reader.readAsDataURL(file);
      }
    };

    // Global exposed functions for inline HTML event handlers
    window.removeImage = (id) => {
      if (isGenerating) return;
      images = images.filter(img => img.id !== id);
      updateUI();
    };

    btnClearAll.addEventListener('click', () => {
      if (isGenerating) return;
      images = [];
      showError(null);
      updateUI();
    });

    // --- Drag and Drop Listeners ---
    emptyState.addEventListener('click', () => fileInput.click());
    
    fileInput.addEventListener('change', (e) => {
      processFiles(Array.from(e.target.files));
      fileInput.value = ''; // Reset
    });

    dropzone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropzone.classList.add('border-indigo-500', 'bg-indigo-50');
      dropzone.classList.remove('border-slate-300', 'bg-slate-50');
      uploadIcon.classList.add('text-indigo-600');
      uploadIcon.classList.remove('text-slate-400');
    });

    dropzone.addEventListener('dragleave', (e) => {
      e.preventDefault();
      dropzone.classList.remove('border-indigo-500', 'bg-indigo-50');
      dropzone.classList.add('border-slate-300', 'bg-slate-50');
      uploadIcon.classList.remove('text-indigo-600');
      uploadIcon.classList.add('text-slate-400');
    });

    dropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropzone.classList.remove('border-indigo-500', 'bg-indigo-50');
      dropzone.classList.add('border-slate-300', 'bg-slate-50');
      uploadIcon.classList.remove('text-indigo-600');
      uploadIcon.classList.add('text-slate-400');
      processFiles(Array.from(e.dataTransfer.files));
    });

    // --- API & Generation Logic ---
    const fetchWithRetry = async (url, options, retries = 5) => {
      const delays = [1000, 2000, 4000, 8000, 16000];
      for (let i = 0; i < retries; i++) {
        try {
          const response = await fetch(url, options);
          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(`Error ${response.status}: ${errorData?.error?.message || 'Failed to generate'}`);
          }
          return await response.json();
        } catch (error) {
          if (i === retries - 1) throw error;
          await new Promise(res => setTimeout(res, delays[i]));
        }
      }
    };

    btnGenerate.addEventListener('click', async () => {
      const pendingImages = images.filter(img => img.status === 'idle' || img.status === 'error');
      const currentPrompt = promptInput.value.trim();
      
      const activeApiKey = apiKey;

      if (pendingImages.length === 0 || !currentPrompt) return;
      if (!activeApiKey) {
        showError("API Key missing. Please paste your Gemini API key into the 'const apiKey' variable in the code to run locally.");
        return;
      }
      
      isGenerating = true;
      showError(null);
      updateUI();

      let currentCount = downloadCount;

      for (const img of pendingImages) {
        // Update specific image to processing
        const imgIndex = images.findIndex(p => p.id === img.id);
        if (imgIndex !== -1) {
          images[imgIndex].status = 'processing';
          images[imgIndex].errorText = null;
          updateUI();
        }

        try {
          const mimeType = img.dataUrl.match(/data:(.*?);base64/)[1];
          const base64Data = img.dataUrl.split(',')[1];

          const payload = {
            contents: [
              {
                role: "user",
                parts: [
                  { text: currentPrompt },
                  { inlineData: { mimeType: mimeType, data: base64Data } }
                ]
              }
            ],
            generationConfig: {
              responseModalities: ["TEXT", "IMAGE"]
            }
          };

          const result = await fetchWithRetry(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${activeApiKey}`,
            {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            }
          );

          const outputBase64 = result.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
          
          if (outputBase64) {
            const generatedImageData = `data:image/jpeg;base64,${outputBase64}`;
            const fileName = `unit${String(currentCount).padStart(3, '0')}.jpg`;
            
            // Trigger automatic download
            const link = document.createElement('a');
            link.href = generatedImageData;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            currentCount++;

            // Update image status to done
            images[imgIndex].status = 'done';
            images[imgIndex].resultDataUrl = generatedImageData;
            images[imgIndex].fileName = fileName;

          } else {
            throw new Error("No image data returned from the model.");
          }
        } catch (err) {
          console.error("Generation error for image:", img.id, err);
          images[imgIndex].status = 'error';
          images[imgIndex].errorText = err.message || "Failed to process image.";
        }
        
        updateUI(); // Update UI after each individual image finishes
      }

      downloadCount = currentCount;
      isGenerating = false;
      updateUI();
    });

    // Initial render
    updateUI();

  </script>
</body>
</html>